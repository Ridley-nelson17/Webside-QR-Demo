<!DOCTYPE html>
<html>
<head>
  <title>Real-time QR Code Scanner</title>
  <script async src="https://docs.opencv.org/master/opencv.js" onload="onOpenCvReady();" type="text/javascript"></script>
</head>
<body>
  <h1>Real-time QR Code Scanner</h1>
  <video id="video" width="250" height="250" playsinline></video>
  <canvas id="canvas" style="display:none"></canvas>
  <div id="result"></div>
  <script>
    let video = document.getElementById("video");
    let canvas = document.getElementById("canvas");
    let context = canvas.getContext("2d");
    let videoStream;
    let codeReader;
    let isProcessing = false;
    function onOpenCvReady() {
      codeReader = new cv.QRCodeDetector();
      if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
        navigator.mediaDevices.getUserMedia({ video: true })
          .then(function (stream) {
            video.srcObject = stream;
            video.play();
            videoStream = stream;
            tick();
          })
          .catch(function (error) {
            console.error(error);
          });
      }
    }
    function tick() {
      if (isProcessing) {
        requestAnimationFrame(tick);
        return;
      }
      isProcessing = true;
      canvas.hidden = false;
      canvas.height = video.videoHeight;
      canvas.width = video.videoWidth;
      context.drawImage(video, 0, 0, canvas.width, canvas.height);
      let imageData = context.getImageData(0, 0, canvas.width, canvas.height);
      let imgMat = cv.matFromImageData(imageData);
      let bbox = new cv.Rect();
      let data = codeReader.detectAndDecode(imgMat, bbox);
      if (data.length > 0) {
        document.getElementById("result").textContent = data;
      }
      isProcessing = false;
      requestAnimationFrame(tick);
    }
    window.addEventListener('beforeunload', function() {
      videoStream.getTracks()[0].stop();
    });
  </script>
</body>
</html>